{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}メンバー招待 | 引越しGO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/invite_member.css' %}">
{% endblock %}

{% block content %}
<div class="invite-wrapper">
  <h2>メンバー招待</h2>

  <!-- ▼ owner 専用 -->
  <div class="invite-content">
    <p class="invite-note">
      この招待URLは、すでにアカウントをお持ちの方も<br>利用できます。
    </p>

    <p>1. 招待URL発行ボタンをクリックしてリンクを<br>表示します。</p>
    <p>2. リンクを招待するメンバーに共有し、登録して<br>もらってください。</p>

    <div class="invite-description">
      <p class="invite-item">
        ⚪︎<strong>アカウントを持っていない方</strong>：<br>招待URLから登録すると、この引越しグループに参加できます。</p>
      <p class="invite-item">
        ⚪︎<strong>アカウントを持っているが未ログインの方</strong>：<br>招待URL → ログイン → 参加できます。</p>
      <p class="invite-item">
        ⚪︎<strong>すでにログイン中の方</strong>：<br>招待URLを開くだけで参加できます。</p>
    </div>

    <button id="generate-btn" class="btn-generate">招待URLを発行</button>
    <input type="text" id="invite-url" readonly placeholder="ここに招待URLが表示されます">
    <button id="copy-btn" class="btn-copy">コピー</button>
    <button type="button" id="email-share-btn" class="btn-share">メールで共有</button>
  </div>
</div>

<script>
document.getElementById("generate-btn").addEventListener("click", function() {
  fetch("{% url 'generate_invite_url' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.invite_url) {
      const input = document.getElementById("invite-url");
      input.value = data.invite_url;
    } else {
      alert("URLの生成に失敗しました。");
    }
  })
  .catch(error => console.error("Error:", error));
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const copyBtn = document.getElementById("copy-btn");
  const inviteUrl = document.getElementById("invite-url");

  copyBtn.addEventListener("click", () => {
    if (inviteUrl.value.trim() === "") {
      alert("先にURLを発行してください。");
      return;
    }

    navigator.clipboard.writeText(inviteUrl.value)
      .then(() => {
        copyBtn.textContent = "コピーしました！";
        copyBtn.style.backgroundColor = "#c9f0d6"; // 緑っぽく変化
        setTimeout(() => {
          copyBtn.textContent = "コピー";
          copyBtn.style.backgroundColor = "";
        }, 1500);
      })
      .catch(err => alert("コピーに失敗しました: " + err));
  });
});
</script>

<script>
const emailShareBtn = document.getElementById("email-share-btn");

if (emailShareBtn) {
  emailShareBtn.addEventListener("click", function() {
    const inviteUrl = document.getElementById("invite-url").value;

    if (!inviteUrl) {
      alert("先に招待URLを発行してください。");
      return;
    }

    // メール本文と件名
    const subject = encodeURIComponent("【引越しGO】メンバー招待リンクのお知らせ");
    const body = encodeURIComponent(
      `こんにちは！\n\n引越しGOのメンバー招待リンクです。\n下記のURLから登録をお願いします。\n\n${inviteUrl}\n\nよろしくお願いします！`
    );

    // メールアプリを起動
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  });
}
</script>
{% endblock %}