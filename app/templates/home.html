{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}引越しGO | 引越しGO{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}?v=20260201">
{% endblock %}

{% block content %}
<div class="home-wrapper">
  <h2>引越しGO</h2>

  <!-- メインコンテンツ -->
  <main class="main-container">
      <section class="countdown-card">
          <div class="date-input">
              <label for="move-date">引越し日：</label>
              <input type="date" id="move-date">
          </div>

          <p class="auto-save-note">
            ※入力内容は自動的に保存されます
          </p>

          <h2>引越しまであと</h2>
          <p class="countdown">
            <!-- 数字表示（is_move_date_set の時だけ表示） -->
            <span id="days-left" {% if not is_move_date_set %}style="display:none"{% endif %}>--</span>
            <span id="days-suffix" {% if not is_move_date_set %}style="display:none"{% endif %}>日！</span>

            <!-- 登録してください（is_move_date_set の時は非表示） -->
            <span class="countdown-message" id="countdown-message"
                  {% if is_move_date_set %}style="display:none"{% endif %}>
              引越し日を登録してください
            </span>
          </p>
      </section>

      <section class="progress-section">
          <p class="progress-label">達成度</p>

          <!-- 達成バー -->
          <div class="progress-bar">
            <div class="progress" id="progress-bar-inner" style="width: {{ progress_rate }}%;"></div>
          </div>

          <div class="progress-labels">
            <span>0%</span>
            <span>{{ progress_rate }}%</span>
            <span>100%</span>
          </div>
      </section>
  </main>

  <script>
      const dateInput = document.getElementById("move-date");
      const daysLeftDisplay = document.getElementById("days-left");
      const serverMoveDate = "{{ move_date|date:'Y-m-d'|default:'' }}";

      let beforeOpenValue = "";
      let openedAt = 0;

      let pendingValue = null;

      function todayYmdLocal() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      // ページ読み込み時に保存された日付を反映
      window.addEventListener("load", () => {
        if (dateInput && serverMoveDate) {
          dateInput.value = serverMoveDate;
          updateCountdown();
        } 
      });

        // 日付変更時：保存してリロード
        if (dateInput) {
          const markBefore = () => {
            beforeOpenValue = dateInput.value || "";
            openedAt = Date.now();
            pendingValue = null;
          };
          dateInput.addEventListener("focus", markBefore);
          dateInput.addEventListener("click", markBefore);
          dateInput.addEventListener("pointerdown", markBefore);

          dateInput.addEventListener("input", () => {
            updateCountdown();
          });

          dateInput.addEventListener("change", () => {
            // if (!dateInput.value) return;
            updateCountdown();
            pendingValue = dateInput.value;
          });

          dateInput.addEventListener("blur", () => {
            if (pendingValue === null) return;

            if (pendingValue === beforeOpenValue) return;

            const tooFast = (Date.now() - openedAt) < 1200;
            const isAutoToday = (beforeOpenValue === "") && (pendingValue === todayYmdLocal()) && tooFast;
            if (isAutoToday) return;
                
            fetch("{% url 'set_move_date' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
              },
              body: new URLSearchParams({
                move_date: pendingValue
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === "ok") {
                location.reload();
              } else {
                alert("引越し日の保存に失敗しました");
              }
            });
        });
       }

        function updateCountdown() {
          if (!dateInput) return;

          const msg = document.getElementById("countdown-message");
          const suffix = document.getElementById("days-suffix");

          if (!dateInput.value) {
            if (daysLeftDisplay) daysLeftDisplay.style.display = "none";
            if (suffix) suffix.style.display = "none";
            if (msg) msg.style.display = "inline";
            return;
          }

          if (msg) msg.style.display = "none";
          if (daysLeftDisplay) daysLeftDisplay.style.display = "inline";
          if (suffix) suffix.style.display = "inline";

          const moveDate = new Date(dateInput.value);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const diff = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));

           if (isNaN(diff)) {
                daysLeftDisplay.textContent = "？";
           } else if (diff < 0) {
                daysLeftDisplay.textContent = "0";
           } else {
                daysLeftDisplay.textContent = diff;
           }
      }
  </script>
{% endblock %}