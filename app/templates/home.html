{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}引越しGO | 引越しGO{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="home-wrapper">
  <h2>引越しGO</h2>

  <!-- メインコンテンツ -->
  <main class="main-container">
      <section class="countdown-card">
          <div class="date-input">
              <label for="move-date">引越し日：</label>
              <input type="date" id="move-date">
          </div>
          <h2>引越しまであと</h2>
          <p class="countdown"><span id="days-left">10</span>日！</p>
      </section>

      <section class="progress-section">
          <p class="progress-label">達成度</p>

          <!-- 達成バー -->
          <div class="progress-bar">
            <div class="progress" id="progress-bar-inner" style="width: {{ progress_rate }}%;"></div>
          </div>

          <div class="progress-labels">
            <span>0%</span>
            <span>{{ progress_rate }}%</span>
            <span>100%</span>
          </div>
      </section>
  </main>

  <script>
      const dateInput = document.getElementById("move-date");
      const daysLeftDisplay = document.getElementById("days-left");

      const serverMoveDate = "{{ move_date|date:'Y-m-d'|default:'' }}";

      // ページ読み込み時に保存された日付を反映
      window.addEventListener("load", () => {
          const savedDate = localStorage.getItem("moveDate");

          if (serverMoveDate) {
              dateInput.value = serverMoveDate;
              updateCountdown();
          } else if (savedDate) {  
              dateInput.value = savedDate;
              updateCountdown();  // 差を再計算して「あと◯日」に反映
          }
      });

        // 日付変更時に保存・再計算
        dateInput.addEventListener("change", () => {
            localStorage.setItem("moveDate", dateInput.value);  // 選んだ日付をブラウザ内に保存
            updateCountdown();  // 差を再計算して「あと◯日」に反映
      });

        function updateCountdown() {
            const moveDate = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);  // 時間をリセット
            const diff = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));

           if (isNaN(diff)) {
                daysLeftDisplay.textContent = "？";
           } else if (diff < 0) {
                daysLeftDisplay.textContent = "0";
           } else {
                daysLeftDisplay.textContent = diff;
           }
      }
  </script>
{% endblock %}