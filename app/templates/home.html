{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}引越しGO | 引越しGO{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="home-wrapper">
  <h2>引越しGO</h2>

  <!-- メインコンテンツ -->
  <main class="main-container">
      <section class="countdown-card">
          <div class="date-input">
              <label for="move-date">引越し日：</label>
              <input type="date" id="move-date">
          </div>
          <h2>引越しまであと</h2>
          <p class="countdown">
            {% if is_move_date_set %}
              <span id="days-left">--</span>日！
            {% else %}
              <span class="countdown-message">
                引っ越し日を登録してください
              </span>
            {% endif %}
          </p>
      </section>

      <section class="progress-section">
          <p class="progress-label">達成度</p>

          <!-- 達成バー -->
          <div class="progress-bar">
            <div class="progress" id="progress-bar-inner" style="width: {{ progress_rate }}%;"></div>
          </div>

          <div class="progress-labels">
            <span>0%</span>
            <span>{{ progress_rate }}%</span>
            <span>100%</span>
          </div>
      </section>
  </main>

  <script>
      const dateInput = document.getElementById("move-date");
      const daysLeftDisplay = document.getElementById("days-left");
      const serverMoveDate = "{{ move_date|date:'Y-m-d'|default:'' }}";

      // ページ読み込み時に保存された日付を反映
      window.addEventListener("load", () => {
        if (serverMoveDate && dateInput) {
          dateInput.value = serverMoveDate;
          updateCountdown();
        } 
      });

        // 日付変更時：保存してリロード
        if (dateInput) {
          dateInput.addEventListener("change", () => {
            if (!dateInput.value) return;
                
            fetch("{% url 'set_move_date' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
              },
              body: new URLSearchParams({
                move_date: dateInput.value
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.status === "ok") {
                location.reload();
              } else {
                alert("引越し日の保存に失敗しました");
              }
            });
        });
       }

        function updateCountdown() {
          if (!daysLeftDisplay || !dateInput.value) return;

          const moveDate = new Date(dateInput.value);
          const today = new Date();
          today.setHours(0, 0, 0, 0);  // 時間をリセット
          const diff = Math.ceil((moveDate - today) / (1000 * 60 * 60 * 24));

           if (isNaN(diff)) {
                daysLeftDisplay.textContent = "？";
           } else if (diff < 0) {
                daysLeftDisplay.textContent = "0";
           } else {
                daysLeftDisplay.textContent = diff;
           }
      }
  </script>
{% endblock %}