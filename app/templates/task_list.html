{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}タスク一覧 | 引越しGO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task_list.css' %}">
{% endblock %}

{% block content %}
<div class="task-list-wrapper">
  <div class="task-header">
    <h2>タスク一覧</h2>
    <button class="new-task-btn" onclick="location.href='/task/create/'">新規登録</button>
  </div>

  <div class="task-scroll-area">
    <div class="task-container" id="task-container">
      {% for task in tasks %}
        <div class="task-row" data-id="{{ task.id }}">
          <!-- チェックボックス（カードの外） -->
          <input type="checkbox" class="task-checkbox" data-id="{{ task.id }}" {% if task.is_completed %}checked{% endif %}>

          <!-- タスクカード -->
          <div class="task-card {% if task.is_completed %}completed{% endif %}"
               onclick="openModal('{{ task.id }}', '{{ task.custom_task|default:task.task_name }}', '{{ task.date|date:'Y年n月j日' }}', '{{ task.start_time }}〜{{ task.end_time }}', '{{ task.memo|default:'（なし）' }}')">
            <p><strong>{{ task.custom_task|default:task.task_name }}</strong></p>
            <p>{{ task.date|date:"Y年n月j日" }}　{{ task.start_time }}〜{{ task.end_time }}</p>
            <p>{{ task.memo|default:"（なし）" }}</p>
          </div>

          <!-- 削除ボタン（カードの外） -->
          <button class="delete-btn" data-id="{{ task.id }}">削除</button>
        </div>
      {% empty %}
        <p>まだタスクが登録されていません。</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ✅ 詳細モーダル -->
<div id="taskModal" class="modal">
  <div class="modal-content">
    <h3 id="modal-task-name"></h3>
    <p id="modal-task-date"></p>
    <p id="modal-task-time"></p>
    <p id="modal-task-memo"></p>
    <div class="modal-buttons">
      <button id="editTaskBtn" class="modal-btn modal-edit">修正</button>
      <button id="closeModalBtn" class="modal-btn modal-close">閉じる</button>
    </div>
  </div>
</div>

<!-- ✅ 削除確認モーダル -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <p>内容を削除します。</p>
    <div class="modal-buttons">
      <button id="confirmDelete" class="modal-btn modal-delete">削除</button>
      <button id="cancelDelete" class="modal-btn modal-cancel">キャンセル</button>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');
const container = document.getElementById('task-container');

/* ✅ 並び替え関数（未完→完了） */
function resortTasks() {
  const rows = Array.from(container.children);
  const incomplete = rows.filter(r => !r.querySelector('.task-checkbox').checked);
  const complete = rows.filter(r => r.querySelector('.task-checkbox').checked);
  container.innerHTML = '';
  [...incomplete, ...complete].forEach(r => container.appendChild(r));
}

/* ✅ チェック切替 */
container.addEventListener('change', async (e) => {
  const box = e.target.closest('.task-checkbox');
  if (!box) return;
  const row = box.closest('.task-row');
  const card = row.querySelector('.task-card');
  const taskId = box.dataset.id;

  card.classList.toggle('completed', box.checked);
  resortTasks();

  try {
    const res = await fetch(`/task/toggle/${taskId}/`);
    const data = await res.json();
    card.classList.toggle('completed', data.is_completed);
    resortTasks();
  } catch (err) {
    console.error('更新エラー:', err);
  }
});

/* ✅ 詳細モーダル */
const modal = document.getElementById('taskModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const editTaskBtn = document.getElementById('editTaskBtn');

function openModal(id, name, date, time, memo) {
  document.getElementById('modal-task-name').textContent = name;
  document.getElementById('modal-task-date').textContent = date;
  document.getElementById('modal-task-time').textContent = time;
  document.getElementById('modal-task-memo').textContent = memo;
  editTaskBtn.onclick = () => location.href = `/task/edit/${id}/`;
  modal.style.display = 'block';
}
closeModalBtn.onclick = () => modal.style.display = 'none';
window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

/* ✅ 削除モーダル */
const deleteModal = document.getElementById('deleteModal');
const confirmDelete = document.getElementById('confirmDelete');
const cancelDelete = document.getElementById('cancelDelete');
let targetTaskId = null;
let targetRow = null;

container.addEventListener('click', (e) => {
  const btn = e.target.closest('.delete-btn');
  if (!btn) return;
  targetTaskId = btn.dataset.id;
  targetRow = btn.closest('.task-row');
  deleteModal.style.display = 'block';
});

confirmDelete.addEventListener('click', async () => {
  if (!targetTaskId) return;
  try {
    const res = await fetch(`/task/delete/${targetTaskId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    });
    if (res.ok) {
      targetRow.remove();
      deleteModal.style.display = 'none';
    } else {
      alert('削除に失敗しました');
    }
  } catch {
    alert('通信エラーが発生しました');
  }
});

cancelDelete.addEventListener('click', () => {
  deleteModal.style.display = 'none';
});
window.addEventListener('click', (e) => {
  if (e.target === deleteModal) deleteModal.style.display = 'none';
});

resortTasks();
</script>
{% endblock %}