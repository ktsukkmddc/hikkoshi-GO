{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}掲示板 | 引越しGO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/message_list.css' %}">
{% endblock %}

{% block content %}
<div class="message-list-wrapper">
  <h2>メッセージ</h2>

  <div class="message-header">
    <form method="GET" class="search-form">
        <input type="text" name="q" placeholder="検索..." value="{{ request.GET.q }}">
        <button type="submit">検索</button>
    </form>

    {% if request.user.move_info %}
      <a href="{% url 'message_register' %}" class="btn-new-message">メッセージを送る</a>
    {% else %}
      <a href="{% url 'home' %}" class="btn-new-message">新規登録</a>
    {% endif %}
  </div>

  <!-- メッセージ一覧 -->
  {% if messages %}
    <div class="message-cards">
      {% for msg in messages %}
        <div class="message-row" data-id="{{ msg.id }}">
          <div class="message-card">
            <p class="message-from">
              {{ msg.sender.full_name }} → @{{ msg.receiver.full_name }}
            </p>
            <p class="message-content">{{ msg.content }}</p>
            <p class="message-date">{{ msg.created_at|date:"Y/m/d H:i" }}</p>
          </div>

          <!-- 削除ボタン -->
          <button class="delete-btn message-delete-btn" data-id="{{ msg.id }}">
            削除
          </button>
        </div>
      {% endfor %}
    </div>
  {% else %}
    {% if not request.user.move_info %}
      <p class="need-moveinfo">
        <span class="need-moveinfo-emphasis">メッセージを使うには、先にホーム画面で引越し日を登録してください。</span>
      </p>
    {% else %}
      <p class="no-message">まだメッセージはありません。</p>
    {% endif %}
  {% endif %}
</div>

<script>
  // CSRF（Djangoテンプレで csrf_token を使う）
  const CSRF_TOKEN = "{{ csrf_token }}";

  // クリック貫通を止める：削除ボタンは pointerdown でも止める（スマホ/PC安定）
  document.addEventListener("pointerdown", (e) => {
    const btn = e.target.closest(".message-delete-btn");
    if (!btn) return;
    e.stopPropagation();
  }, true); // ← capture重要

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".message-delete-btn");
    if (!btn) return;

    // ここでも止める（二重で保険）
    e.preventDefault();
    e.stopPropagation();

    const messageId = btn.dataset.id;
    if (!messageId) return;

    if (!confirm("このメッセージを削除しますか？")) return;

    try {
      const res = await fetch(`/message/delete/${messageId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": CSRF_TOKEN,
        },
      });

      if (!res.ok) {
        alert("削除に失敗しました");
        return;
      }

      const data = await res.json();

      if (data.status === "ok") {
        const row = btn.closest(".message-row");
        if (row) row.remove();
      } else {
        alert("削除に失敗しました");
      }
    } catch (err) {
      console.error(err);
      alert("通信エラーが発生しました");
    }
  }, true); // ← captureにして“先に”拾うと貫通しにくい
</script>
{% endblock %}