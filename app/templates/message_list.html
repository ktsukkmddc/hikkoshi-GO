{% extends 'base_with_nav.html' %}
{% load static %}

{% block title %}掲示板 | 引越しGO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/message_list.css' %}">
{% endblock %}

{% block content %}
<div class="message-list-wrapper">
  <h2>メッセージ</h2>

  <div class="message-header">
    <form method="GET" class="search-form">
        <input type="text" name="q" placeholder="検索..." value="{{ request.GET.q }}">
        <button type="submit">検索</button>
    </form>

    {% if request.user.move_info %}
      <a href="{% url 'message_register' %}" class="btn-new-message">メッセージを送る</a>
    {% else %}
      <a href="{% url 'home' %}" class="btn-new-message">新規登録</a>
    {% endif %}
  </div>

  <!-- メッセージ一覧 -->
  {% if messages %}
    <div class="message-cards">
      {% for msg in messages %}
        <div class="message-row" data-id="{{ msg.id }}">
          <div class="message-card">
            <p class="message-from">
              {{ msg.sender.full_name }} → @{{ msg.receiver.full_name }}
            </p>
            <p class="message-content">{{ msg.content }}</p>
            <p class="message-date">{{ msg.created_at|date:"Y/m/d H:i" }}</p>
          </div>

          <!-- 削除ボタン -->
          <button class="delete-btn message-delete-btn" data-id="{{ msg.id }}">
            削除
          </button>
        </div>
      {% endfor %}
    </div>
  {% else %}
    {% if not request.user.move_info %}
      <p class="need-moveinfo">
        <span class="need-moveinfo-emphasis">メッセージを使うには、先にホーム画面で引越し日を登録してください。</span>
      </p>
    {% else %}
      <p class="no-message">まだメッセージはありません。</p>
    {% endif %}
  {% endif %}
</div>

<!-- ✅ メッセージ削除確認モーダル -->
<div id="messageDeleteModal" class="modal">
  <div class="modal-content">
    <p>内容を削除します。</p>
    <div class="modal-buttons">
      <button id="messageConfirmDelete" class="modal-btn modal-delete">削除</button>
      <button id="messageCancelDelete" class="modal-btn modal-cancel">キャンセル</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const CSRF_TOKEN = "{{ csrf_token }}";

  const deleteModal  = document.getElementById("messageDeleteModal");
  const confirmBtn   = document.getElementById("messageConfirmDelete");
  const cancelBtn    = document.getElementById("messageCancelDelete");
  const modalContent = deleteModal?.querySelector(".modal-content");

  // ✅ 取れてなかったらここで止めて、原因が分かるようにする
  if (!deleteModal || !confirmBtn || !cancelBtn) {
    console.log("modal elements missing:", { deleteModal, confirmBtn, cancelBtn });
    return;
  }

  let targetMessageId = null;
  let targetRow = null;

  // ✅ 削除ボタンを押したらモーダルを開く（イベント委任）
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".message-delete-btn");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    targetMessageId = btn.dataset.id;
    targetRow = btn.closest(".message-row");
    if (!targetMessageId || !targetRow) return;

    deleteModal.style.display = "block";
  }, true);

  // ✅ 削除実行
  confirmBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (!targetMessageId) return;

    try {
      const res = await fetch(`/message/delete/${targetMessageId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": CSRF_TOKEN },
      });

      const data = await res.json();

      if (res.ok && data.status === "ok") {
        targetRow?.remove();
        deleteModal.style.display = "none";
        targetMessageId = null;
        targetRow = null;
      } else {
        alert("削除に失敗しました");
      }
    } catch (err) {
      console.error(err);
      alert("通信エラーが発生しました");
    }
  });

  // ✅ キャンセル
  cancelBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    deleteModal.style.display = "none";
    targetMessageId = null;
    targetRow = null;
  });

  // ✅ 背景クリックで閉じる
  deleteModal.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
      e.stopPropagation();
      deleteModal.style.display = "none";
      targetMessageId = null;
      targetRow = null;
    }
  });

  // ✅ モーダル内クリックは外へ漏らさない（貫通防止）
  if (modalContent) {
    modalContent.addEventListener("click", (e) => e.stopPropagation());
    modalContent.addEventListener("pointerdown", (e) => e.stopPropagation(), true);
  }

  // ✅ 削除ボタンの pointerdown でも止める
  document.addEventListener("pointerdown", (e) => {
    const btn = e.target.closest(".message-delete-btn");
    if (!btn) return;
    e.stopPropagation();
  }, true);
});
</script>
{% endblock %}